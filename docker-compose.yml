services:
  main:
    build: .
    command: /home/user/code tunnel --name $HOSTNAME --no-sleep
    entrypoint: |
      bash -c '
        if ls -dl /home/user | grep " user "; then
          usermod  -l $$USER -u $$USER_UID user
          groupmod -n $$USER -g $$USER_GID user
          chown -R $$USER:$$USER /home/user
        fi
        if [ ! -d socsel-analysis-modules ]; then
          git clone "https://github.com/Wakayama-SocSEL/socsel-analysis-modules.git"
          chown -R $$USER:$$USER socsel-analysis-modules
        fi
        exec gosu $$USER "$$0" "$$@"
      '
    environment:
      HOSTNAME: $HOSTNAME
      SHELL: zsh
      USER: $USER
      USER_UID: $USER_UID
      USER_GID: $USER_GID
    user: root
    volumes:
      - .:/workspace
    working_dir: /workspace
